---
title: "Webhook: SERP"
description: "Technical reference for the DataForSEO SERP pingback webhook that receives position tracking results."
---

The SERP webhook is the endpoint DataForSEO calls after completing an asynchronous keyword ranking task. It receives the task ID and tag, retrieves the full results from DataForSEO, extracts the target domain's position, and saves it to the database.

## Endpoint

```
GET /api/webhooks/dataforseo
```

**Triggered by:** DataForSEO SERP task completion (pingback)
**Auth:** `secret` query parameter verified against `DATAFORSEO_WEBHOOK_SECRET`

## Query parameters

DataForSEO calls this URL with the following parameters substituted from its task context:

| Parameter | Source | Description |
|---|---|---|
| `secret` | `DATAFORSEO_WEBHOOK_SECRET` env var | Static secret for request verification |
| `id` | DataForSEO `$id` template | The completed task's unique ID |
| `tag` | DataForSEO `$tag` template | JSON-encoded tag set at task submission time |

The full URL format sent to DataForSEO at task submission:

```
https://rank.pagelyft.studio/api/webhooks/dataforseo?secret={DATAFORSEO_WEBHOOK_SECRET}&id=$id&tag=$tag
```

## Tag structure

The `tag` parameter is a JSON string encoded when the SERP task was submitted by the Track Positions cron job:

```json
{
  "websiteId": "uuid-of-the-website",
  "domain": "example.com"
}
```

The webhook decodes this tag to know which website and domain to look for in the results.

## Execution flow

```
1. Verify `secret` query parameter matches DATAFORSEO_WEBHOOK_SECRET
2. Parse `id` (task ID) and `tag` (JSON) from query parameters
3. Extract websiteId and domain from tag
4. Call DataForSEO googleOrganicTaskGetAdvanced(id) to fetch full results
5. Search results for a ranking entry matching the target domain
6. If found: upsert position data to keyword_position_history
7. If not found: record that the domain was not in the top results
8. Return 200
```

## DataForSEO API call

The webhook calls `googleOrganicTaskGetAdvanced` with the task ID to retrieve the complete SERP result set. It then scans the organic results array for items where the domain matches the tracked website.

The domain match is performed on the full domain string, including subdomain normalization. A keyword tracked for `example.com` matches results appearing on `www.example.com`.

## Database write

On a successful match, the webhook upserts a row into `keyword_position_history`:

| Column | Value |
|---|---|
| `website_id` | From tag |
| `keyword` | From SERP result item |
| `position` | Organic rank position (1–100) |
| `url` | Ranking URL for that keyword |
| `date` | UTC date of the task completion |

Upsert conflict target is `(website_id, keyword, date)` — one record per keyword per day per website.

## Error handling

The webhook returns HTTP 200 for all responses, including errors. This is intentional: DataForSEO interprets non-200 responses as delivery failures and retries the request. Returning 200 on errors prevents retry loops that would re-process already-handled tasks.

Errors are logged to Vercel function logs for investigation.

| Scenario | Behavior |
|---|---|
| Invalid `secret` | Log warning, return 200 |
| Malformed `tag` JSON | Log error, return 200 |
| DataForSEO API error on result fetch | Log error, return 200 |
| Domain not found in results | Record "not ranked", return 200 |
| Database write error | Log error, return 200 |

<Warning>
  Because this endpoint always returns 200, failed writes are silent from DataForSEO's perspective. Monitor Vercel function logs to detect processing failures. Gaps in `keyword_position_history` for a given date indicate webhook processing errors.
</Warning>

## Secret verification

The `secret` query parameter must exactly match `DATAFORSEO_WEBHOOK_SECRET`. Requests with a missing or incorrect secret are rejected (logged and returned 200, not forwarded to processing logic).

The secret is embedded in the pingback URL at task submission time. Keep `DATAFORSEO_WEBHOOK_SECRET` private — anyone with the secret and a valid task ID can write arbitrary position data to your database.

## Local testing

DataForSEO cannot deliver webhooks to `localhost`. To test locally:

1. Start a tunnel (e.g. `ngrok http 3000`).
2. Set `NEXT_PUBLIC_APP_URL` to the tunnel URL in `.env.local`.
3. Submit a real SERP task via the Track Positions cron endpoint.
4. Inspect the incoming webhook request in the tunnel dashboard.

## Related

- [Cron: Track Positions](/reference/cron-track-positions) — submits SERP tasks that trigger this webhook
- [Webhook: OnPage](/reference/webhook-onpage) — the site audit equivalent
- [Environment Variables](/reference/environment-variables) — `DATAFORSEO_WEBHOOK_SECRET` and `NEXT_PUBLIC_APP_URL`
